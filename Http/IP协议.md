# IP协议

网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。网络在发送分组时不需要先建立连接。每一个分组（IP数据报）独立发送，与其前后的分组无关（不进行编号）。网络层不提供服务质量的承诺。

网际协议IP

与IP协议配套使用的还有四个协议：

- 地址解析协议ARP（Address Resolution Protocol）

- 逆地址解析协议RARP（Reverse Address Resolution Protocol）

- 网际控制报文协议ICMP（Internet Control Message Protocol）

- 网际组管理协议IGMP（Internet Group ）

![](https://leanote.com/api/file/getImage?fileId=57ad2d08ab644133ed049171)

网络层使用的中间设备是路由器。

## 分类的IP地址

IP地址的编码方法共经历了三个历史阶段。

- 分类的IP地址

每一类地址都由两个固定长度的字段组成。第一个字段是网络号，它标志着主机（路由器）所连接到的网络。网络号在整个因特网范围内是唯一的。第二个字段是主机号，它标志着该主机（或路由器）。主机号在他所在的网络内是唯一的。所以IP地址是唯一的。

![](https://leanote.com/api/file/getImage?fileId=57ad2d08ab644133ed049172)

- 子网的划分

- 构成超网

## IP数据报的格式

IP数据报由首部和数据两部分组成。
IP首部中固定长度部分20字节

- 版本 占4位，指IP协议的版本

- 首部长度， 占4位，这个字段所表示的长度单位是32位字（即4字节），所以首部最大长度为60字节

- 区分服务， 占8位， 用来获得更好的服务

- 总长度， 指首部和数据之和的长度，单位为字节，数据报最大长度为2^16-1=65535字节。

- 标识， IP软件在存储器中维护一个计数器，每产生一个数据报，计数器就加1，并将此值赋给标识字段。

- 标志， 占3位，不过，只有两位有意义
    - MF（More Fragment），MF=1，表示后面还有分片；MF=0表示这是若干数据报片中的最后一个
    - DF（Don't Fragment）,不能分片，只有当DF=0时，才允许分片

- 片偏移 较长的分组在分片后，某片在原分组中的相对位置。片偏移以8字节为偏移单位。

- 生存时间（TTL），表明数据报在网络中的寿命。其目的是防止无法交付的数据报无限制的在因特网中兜圈子，因而白白消耗网络资源。

- 协议， 指出数据报携带的数据是使用何种协议。

- 首部检验和， 只检验数据报的首部，但不包括数据部分。

- 源地址

- 目的地址

## IP层分组转发算法

1. 从数据报首部提取目的主机的IP地址D，得出目的网络地址为N；
2. 若N就是与路由器直接相连的某个网络地址，则进行直接交付，并直接将数据报交付给目的主机；否则，就间接交付，执行3；
3. 若路由表有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行4；
4. 若路由表中有到达网络N的路由，则把数据报传送给路由表中指明的下一跳路由器，否则，执行5；
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行6；
6. 报告转发错误分组。

## 划分子网

划分子网的基本思路

- 一个拥有许多物理单位，可将所属的物理网络划分为若干个子网（subnet）。对外仍然表现为一个网络。

- 划分子网的方法是从网络的主机号借用若干位作为子网号subnet-id，当然主机号也就响应的减少相同的位数。IP ::= {<网络号>，<子网号>，<主机号>}

- 从其他网络发来的数据报，仍然根据IP数据报的目的地址找到链接在本单位网络的路由器。再找到目的子网，从而找到目的地址。

子网掩码
目的地址与子网掩码执行“&”操作，就可以找到其所属的子网。

构造超网
无分类编址CIDR，

- CIDR消除了传统的A类、B类和C类地址以及划分子网的概念。  IP地址 ::= {<网络前缀>，<主机号>}。
- CIDR把网络前缀相同的连续的IP地址组成一个“CIDR地址块”。

最长前缀匹配

在查找路由表时可能会得到不止一个匹配结果，应当从匹配结果中选择最长的网路前缀路由，这叫做最长前缀匹配。

## 网际控制报文协议（ICMP）

为了更有效的转发IP数据报和提高成功交付的机会，在网际层使用了网际控制报文协议ICMP。ICMP允许主机或者路由器报告差错情况和提供有关异常情况的报告。
ICMP的报文种类：ICMP差错报告报文和ICMP询问报文。
![](https://leanote.com/api/file/getImage?fileId=57ad2d08ab644133ed049170)

不应发送ICMP报文的几种情况

- 对ICMP差错报告报文不发送ICMP差错报告报文

- 对第一个分片的数据报片的所有后续的数据报片都不发送ICMP差错报告报文

- 对具有多播地址的数据报都不发送ICMP差错报告报文

- 对具有特殊地址的数据报不发送ICMP差错报告报文

ICMP询问报文有两种

- 回送请求和回答

- 时间戳请求和回答

### ICMP的应用

PING(Packet InterNet Groper)用来测试两个主机之间的连通性。PING使用了ICMP的回送请求和护送回答报文。PING是应用层直接使用网络层ICMP的一个例子。PING没有通过TCP和UDP。

traceroute(Unix)/tracert(Windows)
用来跟踪一个分组从源点到终点的路径。

分层次的路由选择协议

因特网将整个互联网划分为许多较小的自治系统（autonomous system），一般都记为AS。它的经典定义是在单一技术管理下的一组路由器，而这些路由器使用一种AS内部的路由选择协议用以确定分组在该AS内，同时还使用一种As之间的路由选择协议用以确定分组在AS之间的路由。

路由选择协议可以分为两种，内部网关协议IGP（Interior Gateway Protocol）和外部网关协议EGP（External Gateway Protocol）。