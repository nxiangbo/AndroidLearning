# [译]为什么Flutter使用Dart语言

许多语言学家认为，一个人的自然语言的表达方式会影响他们的思考方式([affects how they think](https://en.wikipedia.org/wiki/Linguistic_relativity))。计算机语言是否适用于这种理念呢？使用不同计算机语言的程序员经常对同一问题提出完全不同的解决方案。有一个比较极端的例子，计算机科学家取消了goto语句，以便于鼓励程序员编写更结构化的程序。

这与Flutter和Dart有什么关系呢？确实有点关系。Flutter团队早期评估了实际中计算机语言，选择Dart是因为它与他们正在构建的用户接口相匹配。

Dart是开发人员喜欢Flutter的一个重要原因。正如一条tweet所说：

以列举了Dart的一些特征，这对Flutter是不可或缺的：

- Dart 使用AOT（Ahead Of Time）编译成快速，可预测的本地代码。它允许几乎所有的Flutter都用Dart编写。这不仅使得Flutter允许速度更快，而且所有东西（包括所有的部件）都可以定制。
- Dart也可以使用JIT（Just in time）编译，用于极快的开发周期和改变游戏规则的工作流程（包括Flutter流行的秒级状态热重载）。
- Dart可以更容易的创建60fps之内的平滑动画和过渡。Dart可以在没有锁的情况下分配对象和垃圾收集。并且，与JavaScript类似，Dart没有使用抢占式调度和共享内存（从而加锁）。因为Flutter 应用被编译成本地代码，所以他们不需要**在执行过程中**建立一个缓慢的桥梁（例如，JavaScript到本地代码）。Flutter应用启动速度也会更快。
- 由于Dart的可声明，可编程布局具有比较容易阅读和良好的可视化，因此，Flutter不需要单独的声明性的布局语言，如JSX或者XML，也不需要单独的可视化界面构建器。
- 开发者发现Dart非常容易学习，因为它有静态语言用户和动态语言用户所熟悉的特征。

并非所有的特征都是Dart独有的，然而，这些特征的组合使得在实现Flutter方面，Dart具有独一无二的优势。可以这么说，如果没有Dart，Flutter很难变得如此强大。

![flutter-loves-dart](images/flutter-loves-dart.png)

本文的剩余部分将会更深入的介绍Dart的特性（包括它的标准库），这些特性使Dart成为实现Flutter的最佳语言。

## 编译和执行

*如果你已经比较熟悉静态和动态语言，AOT和JIT编译，以及虚拟机等主题，那么，你可以跳过这一节*

从历史上看，计算机语言可以分为两类：[静态语言](https://en.wikipedia.org/wiki/Compiled_language)，Fortran和C，它们的变量类型是在编译时输入）和[动态态语言](https://en.wikipedia.org/wiki/Interpreted_language)（Smalltalk和JavaScript，它们的变量类型可以在运行时更改）。静态语言可以被编译成可被机器直接执行的本地机器码（或者汇编代码）。动态语言由解释器直接执行，而不会生成机器代码。

当然，事情最终变的更加复杂。虚拟机的概念变的流行。它实际上是模拟硬件机器的高级解释器。虚拟机可以更轻松的将代码移植到新的硬件平台上。在此情况下，虚拟机的输入语言往往是中间语言。例如，程序语言(例如，Java)被编译成中间语言（字节码），然后在虚拟机（Java虚拟机）上执行。

此外，目前还有即时编译器（JIT）。JIT编译器在程序执行期间运行，即时编译。在创建程序期间（在运行时之前）执行的原始编译器现在称为AOT编译器。

一般来说，只有静态语言适合使用AOT编译成本地机器码，因为机器语言需要知道数据类型，而在动态语言中，数据类型不能够提前确定的。因此，动态语言通常被解释或者JIT编译。

当在开发期间完成AOT编译时，它总是导致更慢的开发周期（对程序进行更改和能够执行程序以查看更改结果之间的时间）。但是AOT编译导致程序可以可预测的执行，而不会在运行时分析和编译。AOT编译的程序执行速度更快（因为它们已经被编译）。

反过来说，JIT提供了更快的开发周期，但是执行速度较慢。尤其是，JIT编译器的启动时间较慢，因为当程序运行时，JIT编译器必须在执行代码之前进行分析和编译。研究表明，如果APP的启动时间超过几秒钟，许多人会放弃这个APP。

到这里，背景知识就结束了。将AOT和JIT的优点结合起来，不是很棒吗？请继续阅读。

## Dart的编译和执行

在开发Dart之前，Dart团队成员已经在高级编译器和虚拟机上做过开创性的工作，包括动态语言（如JavaScript的V8引擎和Smalltalk的Strongtalk）和静态语言（如Java的Hotspot编译器）。它们利用这些经验使得Dart在编译和执行方面异常灵活。

Dart是适合使用AOT和JIT编译的极少数的语言之一(也许是唯一的“主流”语言)。支持这两种编译方式为Dart和（特别是）Flutter提供了显着的优势。

在开发期间使用JIT编译，编译速度是非常快的。然后，当APP准备发布时，使用AOT编译。因此，借助先进的工具和编译器，Dart可以提供两全其美的优势：极快的开发周期，快速的执行和启动时间。

Dart在编译和执行方面的灵活性并不止于此。例如，Dart可以编译成JavaScript，因此可以由浏览器执行。这使得移动端的代码和web端的代码可以复用。开发者有报告指出，移动端和web端的代码复用率可以达到70%。Dart也可以通过编译为本机代码，或者通过编译为JavaScript并与node.js一起使用来在服务器上使用。

最后，Dart还提供了一个独立的虚拟机。它使用Dart语言本身作为中间语言（本质上类似一个解释器）。

Dart可以有效地编译AOT或JIT，解释或转换成其他语言。 Dart编译和执行不仅非常灵活，而且速度特别快。

下一节将举例说明

## 有状态热加载

速度极快的热加载是Flutter最受欢迎的功能之一。在开发过程中，Flutter使用JIT编译器，可以在一秒钟内重新加载并继续执行代码。应用程序状态会尽可能在重新加载时保留，因此应用程序可以从停止的位置继续。

![Flutter-sub-second-show](images/Flutter-sub-second-show.gif)

除非亲身体验，否则很难想象快速的热加载在开发过程中是多么重要。开发人员指出，它改变了他们创建应用程序的方式，将其描述为将应用程序绘制成生命。

下面是移动开发者对Flutter热加载的评价。

> 我测试了一下热重载，因此，我改变了一个颜色，保存我的修改，然后，我爱上了它:heart:
>
> 这个功能让人着迷。我认为Visual Studio中的编辑和继续（Edit & Continue）功能很好用，但热加载简直令人震惊。 只是这一个功能，我认为移动开发人员的工作效率可以提高两倍。
>
> 这对我来说真的是一个改变游戏规则的人。 当我部署代码并且需要很长时间时，我会失去焦点，我会做其他事情，当我回到模拟器/设备时，我已经忘记了我想要测试的内容。 比用5p分钟移动控制2px更令人沮丧的是什么？ 随着颤动，这已不复存在。

Flutter的热加载让人更容易尝试新的idea或者替换方案，这大大提高了创造力。

到目前为止，我们谈论了Dart对开发者更加友好。下一节将介绍Dart是如何轻易的创建让用户满意的流畅APP。

## 避免卡顿

一个快速的APP很好，但是一个流畅的APP更好。一个快速动画是生涩的，仍是比较糟糕的。然而，避免卡顿是非常困难的，因为引起卡顿的原因有很多。Dart有很多功能可以避免很多事情卡顿。

当然，使用Flutter也可能写出卡顿的APP。Dart有助于提高可预测性，让开发人员更好地控制应用程序的流畅性，从而更轻松地提供最佳的用户体验。

结果是？

> 以60 fps为运行标准，使用Flutter创建的用户界面比使用其他跨平台开发框架创建的用户界面执行得更好。

并且不仅仅比跨平台的APP表现好，而且还和native APP表现一样好。

> UI 是非常流畅...我从没见过如此流畅的APP

### AOT编译和“桥”

我们已经讨论了Dart具有保持APP流畅的功能，那就是Dart可以被AOT编译成本地代码。预先编译的AOT代码比JIT编译的代码更可以预测，因为在运行时，不会暂停执行JIT分析和编译。

然而，AOT编译的代码具有更大的优势，即避免了“JavaScript 桥”

18 10 15 17 34 CF 42 72 72 88